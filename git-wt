#!/bin/bash

# Git worktree management script
# Stores worktrees in <configurable-base>/<project-name>/<branch-name>
# Base path can be configured via git config worktree.basepath or $GIT_WT_BASE

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source library files
# shellcheck source=lib/colors.sh
source "$SCRIPT_DIR/lib/colors.sh"
# shellcheck source=lib/validation.sh
source "$SCRIPT_DIR/lib/validation.sh"
# shellcheck source=lib/config.sh
source "$SCRIPT_DIR/lib/config.sh"
# shellcheck source=lib/git-utils.sh
source "$SCRIPT_DIR/lib/git-utils.sh"
# shellcheck source=lib/package-manager.sh
source "$SCRIPT_DIR/lib/package-manager.sh"
# shellcheck source=lib/worktree-ops.sh
source "$SCRIPT_DIR/lib/worktree-ops.sh"
# shellcheck source=lib/fuzzy-finder.sh
source "$SCRIPT_DIR/lib/fuzzy-finder.sh"
# shellcheck source=lib/commands.sh
source "$SCRIPT_DIR/lib/commands.sh"

# Base directory for all worktrees
WORKTREE_BASE=$(get_worktree_base)
export WORKTREE_BASE

# Main command dispatcher
main() {
    local command="${1:-}"

    # Handle flag-based commands
    case "$command" in
        __preview)
            # Internal command for fzf preview pane
            shift
            show_worktree_info "$@"
            ;;
        --list|-l|list|ls)
            cmd_list
            ;;
        --remove|-r|remove|rm)
            shift
            cmd_remove "$@"
            ;;
        --prune|-p|prune)
            cmd_prune
            ;;
        --enable-autoprune)
            git config worktree.autoprune true
            success "Auto-pruning enabled for this repository"
            info "Merged branches will be automatically cleaned up when running git-wt"
            ;;
        --disable-autoprune)
            git config --unset worktree.autoprune 2>/dev/null || true
            success "Auto-pruning disabled for this repository"
            ;;
        --cleanup)
            check_git_repo
            info "Checking for stale worktrees..."
            auto_prune_stale_worktrees
            ;;
        --config)
            cmd_config
            ;;
        --help|-h|help)
            cmd_help
            ;;
        "")
            # No arguments - launch interactive mode
            cmd_interactive
            ;;
        *)
            # Treat as branch name - direct mode
            open_or_create_worktree "$command"
            ;;
    esac
}

# Only run main if script is executed directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
