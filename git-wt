#!/bin/bash

# Git worktree management script
# Stores worktrees in <configurable-base>/<project-name>/<branch-name>
# Base path can be configured via git config worktree.basepath or $GIT_WT_BASE

# Get the directory where this script is located
# Resolve the real path in case the script is executed via a symlink (as in Homebrew)
SCRIPT_PATH="${BASH_SOURCE[0]}"
if command -v readlink &> /dev/null && readlink -f "$SCRIPT_PATH" &> /dev/null; then
    SCRIPT_PATH="$(readlink -f "$SCRIPT_PATH")"
fi
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# Helper to source library files with error handling
source_lib() {
    local lib="$1"
    # shellcheck source=/dev/null
    if ! source "$SCRIPT_DIR/lib/$lib" 2>/dev/null; then
        echo "Error: Failed to source lib/$lib" >&2
        echo "Please ensure git-wt is properly installed" >&2
        exit 1
    fi
}

# Source library files
source_lib "colors.sh"
source_lib "validation.sh"
source_lib "config.sh"
source_lib "git-utils.sh"
source_lib "package-manager.sh"
source_lib "worktree-ops.sh"
source_lib "fuzzy-finder.sh"
source_lib "ui.sh"
source_lib "commands.sh"

# Base directory for all worktrees - validate it's not empty
WORKTREE_BASE=$(get_worktree_base)
if [[ -z "$WORKTREE_BASE" ]]; then
    echo "Error: Failed to determine worktree base path" >&2
    exit 1
fi
export WORKTREE_BASE

# Main command dispatcher
main() {
    local command="${1:-}"

    # Handle flag-based commands
    case "$command" in
        __preview)
            # Internal command for fzf preview pane
            shift
            show_worktree_info "$@"
            ;;
        __list-branches)
            # Internal command for fzf reload after delete/recreate
            generate_branch_list "local-only"
            ;;
        __delete)
            # Internal command for fzf delete operation (with confirmation for uncommitted changes)
            shift
            delete_worktree_with_check "$@"
            ;;
        __recreate)
            # Internal command for fzf recreate operation
            shift
            recreate_worktree "$@"
            ;;
        --list|-l|list|ls)
            cmd_list
            ;;
        --remove|-r|remove|rm)
            shift
            cmd_remove "$@"
            ;;
        --prune|-p|prune)
            cmd_prune
            ;;
        --refresh-env)
            shift
            cmd_refresh_env "$@"
            ;;
        --enable-autoprune)
            git config worktree.autoprune true
            success "Auto-pruning enabled for this repository"
            info "Merged branches will be automatically cleaned up when running git-wt"
            ;;
        --disable-autoprune)
            git config --unset worktree.autoprune 2>/dev/null || true
            success "Auto-pruning disabled for this repository"
            ;;
        --cleanup)
            check_git_repo || exit 1
            info "Checking for stale worktrees..."
            auto_prune_stale_worktrees
            ;;
        --config)
            cmd_config
            ;;
        --help|-h|help)
            cmd_help
            ;;
        "")
            # No arguments - launch interactive mode
            cmd_interactive
            ;;
        *)
            # Treat as branch name - direct mode
            open_or_create_worktree "$command"
            ;;
    esac
}

# Only run main if script is executed directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
